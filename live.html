<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Spotify Activity - Neura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease-in-out;
        }
        
        /* Hide elements without layout shift */
        .hidden-smooth {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .visible-smooth {
            opacity: 1;
            visibility: visible;
            position: relative;
        }
        
        /* Loading animation */
        @keyframes pulse-soft {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .pulse-soft {
            animation: pulse-soft 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <div class="max-w-2xl mx-auto p-4">
        <!-- Header -->
        <header class="text-center mb-8 pt-8">
            <h1 class="text-4xl font-bold mb-2">Your Spotify Activity</h1>
            <p class="text-gray-400">Live from your Spotify account</p>
        </header>

        <!-- Player Card -->
        <div id="player" class="bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700 smooth-transition">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/1024px-Spotify_logo_without_text.svg.png" 
                         alt="Spotify" class="w-8 h-8">
                    <span class="text-lg font-semibold" id="player-title">Your Spotify</span>
                </div>
                <div class="flex items-center space-x-2" id="status-indicator">
                    <div class="w-3 h-3 bg-gray-500 rounded-full smooth-transition" id="status-dot"></div>
                    <span class="text-sm font-medium text-gray-400 smooth-transition" id="status-text">Checking...</span>
                </div>
            </div>
            
            <!-- Content - All states exist but only one is visible -->
            <div class="flex items-center space-x-6 min-h-[140px]">
                <!-- Album Art (Always visible) -->
                <div class="flex-shrink-0">
                    <img id="albumArt" src="https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg" 
                         alt="Album Art" class="w-24 h-24 md:w-32 md:h-32 rounded-xl shadow-lg object-cover smooth-transition">
                </div>
                
                <!-- Track Info -->
                <div class="flex-grow min-w-0">
                    <!-- Not Connected State -->
                    <div id="not-connected-state" class="visible-smooth">
                        <h2 class="text-2xl font-bold text-white mb-2">Not Connected</h2>
                        <p class="text-gray-400 mb-4">Connect your Spotify account to see what you're listening to</p>
                        <a href="index.html" class="inline-block bg-[#1DB954] hover:bg-[#1ed760] text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105 active:scale-95">
                            Connect Spotify
                        </a>
                    </div>

                    <!-- Loading State -->
                    <div id="loading-state" class="hidden-smooth">
                        <div class="space-y-3">
                            <div class="h-7 bg-gray-700 rounded w-3/4 pulse-soft"></div>
                            <div class="h-5 bg-gray-700 rounded w-1/2 pulse-soft"></div>
                            <div class="pt-2">
                                <div class="h-2 bg-gray-700 rounded pulse-soft"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Playing State -->
                    <div id="playing-state" class="hidden-smooth">
                        <h2 id="songName" class="text-2xl font-bold text-white truncate mb-1 smooth-transition">Song Name</h2>
                        <p id="artistName" class="text-lg text-gray-300 truncate mb-4 smooth-transition">Artist Name</p>
                        
                        <!-- Progress -->
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm text-gray-400">
                                <span id="currentTime" class="smooth-transition">0:00</span>
                                <span id="totalTime" class="smooth-transition">0:00</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="progressBar" class="bg-[#1DB954] h-2 rounded-full smooth-transition" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div id="error-state" class="hidden-smooth">
                        <h2 class="text-2xl font-bold text-white mb-2">Connection Issue</h2>
                        <p id="error-message" class="text-gray-400 mb-4">There was a problem loading your Spotify data</p>
                        <button onclick="fetchNowPlaying()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors mr-3 transform hover:scale-105 active:scale-95">
                            <i class="fas fa-redo mr-2"></i>Retry
                        </button>
                        <a href="index.html" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105 active:scale-95">
                            Reconnect
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>üéµ Each user sees their own Spotify activity</p>
            <p class="mt-1">üîÑ Auto-refreshes every 5 seconds</p>
            <p class="mt-1">üîê Secure token handling</p>
        </div>
    </div>

    <script>
        // Configuration - UPDATE THIS!
        const WORKER_URL = 'https://spotify-tester.mthaker630.workers.dev'; // ‚Üê Your Worker URL

        // Show specific state with smooth transitions
        function showState(state, message = '') {
            const states = ['not-connected', 'loading', 'playing', 'error'];
            
            // Hide all states first
            states.forEach(s => {
                const element = document.getElementById(s + '-state');
                element.classList.remove('visible-smooth');
                element.classList.add('hidden-smooth');
            });
            
            // Show current state after a tiny delay for smooth transition
            setTimeout(() => {
                const currentElement = document.getElementById(state + '-state');
                currentElement.classList.remove('hidden-smooth');
                currentElement.classList.add('visible-smooth');
            }, 50);
            
            // Update status indicator
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const playerTitle = document.getElementById('player-title');
            
            switch(state) {
                case 'not-connected':
                    statusDot.className = 'w-3 h-3 bg-gray-500 rounded-full smooth-transition';
                    statusText.textContent = 'Not Connected';
                    playerTitle.textContent = 'Your Spotify';
                    break;
                case 'loading':
                    statusDot.className = 'w-3 h-3 bg-yellow-500 rounded-full smooth-transition pulse-soft';
                    statusText.textContent = 'Loading...';
                    playerTitle.textContent = 'Your Spotify';
                    break;
                case 'playing':
                    statusDot.className = 'w-3 h-3 bg-green-500 rounded-full smooth-transition';
                    statusText.textContent = 'Live';
                    playerTitle.textContent = 'Now Playing';
                    break;
                case 'error':
                    statusDot.className = 'w-3 h-3 bg-red-500 rounded-full smooth-transition';
                    statusText.textContent = 'Error';
                    playerTitle.textContent = 'Your Spotify';
                    if (message) {
                        document.getElementById('error-message').textContent = message;
                    }
                    break;
            }
        }

        // Format time
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        // Exchange code for token using Worker
        async function exchangeCodeForToken(code) {
            showState('loading', 'Connecting to Spotify...');
            
            try {
                const response = await fetch(WORKER_URL + '/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        redirect_uri: window.location.origin + '/live.html'
                    })
                });

                const data = await response.json();
                
                if (data.access_token) {
                    // Store tokens in localStorage
                    localStorage.setItem('spotify_access_token', data.access_token);
                    localStorage.setItem('spotify_refresh_token', data.refresh_token);
                    localStorage.setItem('spotify_token_expiry', Date.now() + (data.expires_in * 1000));
                    localStorage.setItem('spotify_connected', 'true');
                    
                    return data;
                } else {
                    throw new Error(data.error_description || 'Failed to get token');
                }
            } catch (error) {
                console.error('Token exchange error:', error);
                throw error;
            }
        }

        // Check if token is expired
        function isTokenExpired() {
            const tokenExpiry = localStorage.getItem('spotify_token_expiry');
            return tokenExpiry && Date.now() > parseInt(tokenExpiry);
        }

        // Fetch currently playing track
        async function fetchNowPlaying() {
            const accessToken = localStorage.getItem('spotify_access_token');
            
            // Check if token expired
            if (!accessToken || isTokenExpired()) {
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_connected');
                showState('not-connected');
                return;
            }

            showState('loading', 'Loading your music...');

            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    // Token expired
                    localStorage.removeItem('spotify_access_token');
                    localStorage.removeItem('spotify_connected');
                    showState('not-connected');
                    return;
                }

                if (response.status === 204) {
                    // No music playing
                    document.getElementById('songName').textContent = "No music playing";
                    document.getElementById('artistName').textContent = "Play something on Spotify to see it here!";
                    document.getElementById('albumArt').src = "https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg";
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('currentTime').textContent = "0:00";
                    document.getElementById('totalTime').textContent = "0:00";
                    showState('playing');
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.is_playing && data.item) {
                    const track = data.item;
                    
                    // Smooth content updates
                    setTimeout(() => {
                        document.getElementById('songName').textContent = track.name;
                        document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(", ");
                        document.getElementById('albumArt').src = track.album.images[0]?.url || "https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg";
                        
                        const progressMs = data.progress_ms || 0;
                        const durationMs = track.duration_ms;
                        const progressPercent = (progressMs / durationMs) * 100;
                        
                        document.getElementById('progressBar').style.width = `${progressPercent}%`;
                        document.getElementById('currentTime').textContent = formatTime(progressMs);
                        document.getElementById('totalTime').textContent = formatTime(durationMs);
                    }, 100);
                    
                    showState('playing');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showState('error', error.message);
            }
        }

        // Handle OAuth callback
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                console.error('OAuth Error:', error);
                showState('error', `Spotify authorization failed: ${error}`);
                return;
            }

            if (code) {
                try {
                    console.log('Exchanging code for token...');
                    const tokenData = await exchangeCodeForToken(code);
                    
                    if (tokenData.access_token) {
                        console.log('‚úÖ OAuth successful!');
                        
                        // Clean URL - remove the code parameter
                        const cleanUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, '', cleanUrl);
                        
                        showState('loading', 'Loading your music...');
                        setTimeout(fetchNowPlaying, 1000);
                    }
                } catch (error) {
                    console.error('‚ùå OAuth processing error:', error);
                    showState('error', `Connection failed: ${error.message}`);
                }
            }
        }

        // Initialize - Set initial state immediately
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial state without delay
            const isConnected = localStorage.getItem('spotify_connected') === 'true';
            const urlParams = new URLSearchParams(window.location.search);
            const hasCode = urlParams.get('code');
            
            if (hasCode) {
                // We have an OAuth code, handle it
                handleOAuthCallback();
            } else if (isConnected) {
                // Already connected, start fetching
                showState('loading');
                setTimeout(fetchNowPlaying, 100);
                
                // Auto-refresh every 5 seconds
                setInterval(fetchNowPlaying, 5000);
            } else {
                // Not connected
                showState('not-connected');
            }
        });
    </script>
</body>
</html>
