<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Spotify Activity - Neura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <div class="max-w-2xl mx-auto p-4">
        <!-- Header -->
        <header class="text-center mb-8 pt-8">
            <h1 class="text-4xl font-bold mb-2">Your Spotify Activity</h1>
            <p class="text-gray-400">Live from your Spotify account</p>
        </header>

        <!-- Player Card -->
        <div id="player" class="bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700 transition-all duration-300">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/1024px-Spotify_logo_without_text.svg.png" 
                         alt="Spotify" class="w-8 h-8">
                    <span class="text-lg font-semibold" id="player-title">Your Spotify</span>
                </div>
                <div class="flex items-center space-x-2" id="status-indicator">
                    <div class="w-3 h-3 bg-gray-500 rounded-full" id="status-dot"></div>
                    <span class="text-sm font-medium text-gray-400" id="status-text">Checking...</span>
                </div>
            </div>
            
            <!-- Content -->
            <div class="flex items-center space-x-6">
                <!-- Album Art -->
                <div class="flex-shrink-0">
                    <img id="albumArt" src="https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg" 
                         alt="Album Art" class="w-24 h-24 md:w-32 md:h-32 rounded-xl shadow-lg object-cover">
                </div>
                
                <!-- Track Info -->
                <div class="flex-grow min-w-0">
                    <div id="content-area">
                        <!-- Not Connected State -->
                        <div id="not-connected-state">
                            <h2 class="text-2xl font-bold text-white mb-2">Not Connected</h2>
                            <p class="text-gray-400 mb-4">Connect your Spotify account to see what you're listening to</p>
                            <a href="index.html" class="inline-block bg-[#1DB954] hover:bg-[#1ed760] text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                Connect Spotify
                            </a>
                        </div>

                        <!-- Loading State -->
                        <div id="loading-state" class="hidden">
                            <div class="animate-pulse space-y-3">
                                <div class="h-7 bg-gray-700 rounded w-3/4"></div>
                                <div class="h-5 bg-gray-700 rounded w-1/2"></div>
                                <div class="pt-2">
                                    <div class="h-2 bg-gray-700 rounded"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Playing State -->
                        <div id="playing-state" class="hidden">
                            <h2 id="songName" class="text-2xl font-bold text-white truncate mb-1">Song Name</h2>
                            <p id="artistName" class="text-lg text-gray-300 truncate mb-4">Artist Name</p>
                            
                            <!-- Progress -->
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm text-gray-400">
                                    <span id="currentTime">0:00</span>
                                    <span id="totalTime">0:00</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="progressBar" class="bg-[#1DB954] h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Error State -->
                        <div id="error-state" class="hidden">
                            <h2 class="text-2xl font-bold text-white mb-2">Connection Issue</h2>
                            <p id="error-message" class="text-gray-400 mb-4">There was a problem loading your Spotify data</p>
                            <button onclick="fetchNowPlaying()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors mr-3">
                                <i class="fas fa-redo mr-2"></i>Retry
                            </button>
                            <a href="index.html" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                                Reconnect
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>üéµ Each user sees their own Spotify activity</p>
            <p class="mt-1">üîÑ Auto-refreshes every 5 seconds</p>
            <p class="mt-1">üîê No re-authentication needed</p>
        </div>
    </div>

    <script>
        // Configuration - UPDATE THIS!
        const WORKER_URL = 'https://spotify-tester.mthaker630.workers.dev'; // ‚Üê Your Worker URL

        // Get user ID
        function getUserId() {
            return localStorage.getItem('spotify_user_id');
        }

        // Show specific state
        function showState(state, message = '') {
            const states = ['not-connected', 'loading', 'playing', 'error'];
            states.forEach(s => document.getElementById(s + '-state').classList.add('hidden'));
            
            document.getElementById(state + '-state').classList.remove('hidden');
            
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const playerTitle = document.getElementById('player-title');
            
            switch(state) {
                case 'not-connected':
                    statusDot.className = 'w-3 h-3 bg-gray-500 rounded-full';
                    statusText.textContent = 'Not Connected';
                    playerTitle.textContent = 'Your Spotify';
                    break;
                case 'loading':
                    statusDot.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
                    statusText.textContent = 'Connecting...';
                    playerTitle.textContent = 'Your Spotify';
                    break;
                case 'playing':
                    statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    statusText.textContent = 'Live';
                    playerTitle.textContent = 'Now Playing';
                    break;
                case 'error':
                    statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = 'Error';
                    playerTitle.textContent = 'Your Spotify';
                    if (message) {
                        document.getElementById('error-message').textContent = message;
                    }
                    break;
            }
        }

        // Format time
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        // Fetch currently playing
        async function fetchNowPlaying() {
            const userId = getUserId();
            
            if (!userId) {
                showState('not-connected');
                return;
            }

            showState('loading');

            try {
                const response = await fetch(`${WORKER_URL}/current?userId=${encodeURIComponent(userId)}`);
                const data = await response.json();

                if (data.error) {
                    if (data.code === 'NOT_CONNECTED' || data.code === 'SESSION_EXPIRED') {
                        localStorage.removeItem('spotify_connected');
                        showState('not-connected');
                        return;
                    }
                    throw new Error(data.error);
                }

                if (data.is_playing && data.item) {
                    const track = data.item;
                    document.getElementById('songName').textContent = track.name;
                    document.getElementById('artistName').textContent = track.artists.map(a => a.name).join(", ");
                    document.getElementById('albumArt').src = track.album.images[0]?.url || "https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg";
                    
                    const progressMs = data.progress_ms || 0;
                    const durationMs = track.duration_ms;
                    const progressPercent = (progressMs / durationMs) * 100;
                    
                    document.getElementById('progressBar').style.width = `${progressPercent}%`;
                    document.getElementById('currentTime').textContent = formatTime(progressMs);
                    document.getElementById('totalTime').textContent = formatTime(durationMs);
                    
                    showState('playing');
                } else {
                    document.getElementById('songName').textContent = "No music playing";
                    document.getElementById('artistName').textContent = "Play something on Spotify to see it here!";
                    document.getElementById('albumArt').src = "https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg";
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('currentTime').textContent = "0:00";
                    document.getElementById('totalTime').textContent = "0:00";
                    showState('playing');
                }
            } catch (error) {
                console.error('Error:', error);
                showState('error', error.message);
            }
        }

        // Handle OAuth callback
        // In live.html - ENHANCED OAuth handler
async function handleOAuthCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');

    console.log('üîÑ OAuth Callback Details:');
    console.log('Code:', code ? '‚úì Present' : '‚úó Missing');
    console.log('State:', state);
    console.log('Error:', error);
    console.log('Full URL:', window.location.href);

    if (error) {
        console.error('OAuth Error:', error);
        showState('error', `Spotify authorization failed: ${error}`);
        return;
    }

    if (code) {
        const userId = state || localStorage.getItem('pending_spotify_user');
        
        console.log('üì¶ Processing OAuth callback:');
        console.log('User ID:', userId);
        console.log('Code length:', code.length);

        if (!userId) {
            console.error('No user ID found for OAuth callback');
            showState('error', 'Session expired - please try connecting again');
            return;
        }

        showState('loading', 'Connecting to Spotify...');

        try {
            const callbackUrl = `${WORKER_URL}/callback`;
            console.log('Calling worker callback:', callbackUrl);
            
            const response = await fetch(callbackUrl, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ 
                    code: code, 
                    userId: userId,
                    redirectUri: window.location.origin + '/live.html'
                })
            });

            console.log('Callback response status:', response.status);
            
            const data = await response.json();
            console.log('Callback response data:', data);

            if (!response.ok) {
                throw new Error(data.error || `HTTP ${response.status}`);
            }

            if (data.success) {
                console.log('‚úÖ OAuth successful!');
                localStorage.setItem('spotify_connected', 'true');
                localStorage.setItem('spotify_user_id', userId);
                localStorage.removeItem('pending_spotify_user');
                
                // Clean URL - remove the code parameter
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, '', cleanUrl);
                console.log('URL cleaned, redirecting to:', cleanUrl);
                
                showState('loading', 'Loading your music...');
                // Wait a moment then fetch
                setTimeout(fetchNowPlaying, 1500);
            } else {
                throw new Error(data.error || 'OAuth failed');
            }
        } catch (error) {
            console.error('‚ùå OAuth processing error:', error);
            showState('error', `Connection failed: ${error.message}`);
        }
    } else {
        console.log('‚ÑπÔ∏è No OAuth code in URL - checking existing connection');
    }
}

        // Add this debug function
async function debugAuth() {
    const userId = getUserId();
    console.log('üîç Debug Info:');
    console.log('User ID:', userId);
    console.log('Worker URL:', WORKER_URL);
    console.log('URL being called:', `${WORKER_URL}/current?userId=${encodeURIComponent(userId)}`);
    console.log('Spotify Connected in localStorage:', localStorage.getItem('spotify_connected'));
    console.log('Pending Spotify User:', localStorage.getItem('pending_spotify_user'));
    
    // Test the worker directly
    try {
        const testResponse = await fetch(`${WORKER_URL}/health`);
        const testData = await testResponse.json();
        console.log('Worker health check:', testData);
    } catch (err) {
        console.error('Worker health check failed:', err);
    }
}

// Call this in your DOMContentLoaded
debugAuth();
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            handleOAuthCallback(); // Handle callback if exists
            
            // If no callback, check existing connection
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.get('code')) {
                const isConnected = localStorage.getItem('spotify_connected') === 'true';
                if (isConnected) {
                    fetchNowPlaying();
                    // Auto-refresh every 5 seconds
                    setInterval(fetchNowPlaying, 5000);
                } else {
                    showState('not-connected');
                }
            }
        });
    </script>
</body>
</html>
