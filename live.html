<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Spotify Activity - Neura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .smooth-transition { transition: all 0.3s ease-in-out; }
        .hidden-smooth { opacity: 0; visibility: hidden; position: absolute; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .visible-smooth { opacity: 1; visibility: visible; position: relative; }
        @keyframes pulse-soft { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        .pulse-soft { animation: pulse-soft 2s infinite; }
        .profile-pic { border: 2px solid #1DB954; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <div class="max-w-2xl mx-auto p-4">
        <header class="text-center mb-8 pt-8">
            <h1 class="text-4xl font-bold mb-2">Your Spotify Activity</h1>
            <p class="text-gray-400">Live from your Spotify account</p>
        </header>

        <!-- User Profile Section -->
        <div id="user-profile" class="bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700 mb-6 smooth-transition hidden-smooth">
            <div class="flex items-center space-x-4">
                <img id="user-avatar" src="https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg" 
                     alt="Profile" class="w-16 h-16 rounded-full profile-pic object-cover">
                <div class="flex-grow">
                    <h2 id="user-name" class="text-xl font-bold text-white">Spotify User</h2>
                    <p id="user-email" class="text-gray-400 text-sm">Connected to Spotify</p>
                </div>
                <div class="text-right">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-xs text-green-400 mt-1 block">Connected</span>
                </div>
            </div>
        </div>

        <!-- Player Card -->
        <div id="player" class="bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-700 smooth-transition">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/1024px-Spotify_logo_without_text.svg.png" 
                         alt="Spotify" class="w-8 h-8">
                    <span class="text-lg font-semibold" id="player-title">Now Playing</span>
                </div>
                <div class="flex items-center space-x-2" id="status-indicator">
                    <div class="w-3 h-3 bg-gray-500 rounded-full smooth-transition" id="status-dot"></div>
                    <span class="text-sm font-medium text-gray-400 smooth-transition" id="status-text">Checking...</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-6 min-h-[140px]">
                <div class="flex-shrink-0">
                    <img id="albumArt" src="https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg" 
                         alt="Album Art" class="w-24 h-24 md:w-32 md:h-32 rounded-xl shadow-lg object-cover smooth-transition">
                </div>
                
                <div class="flex-grow min-w-0">
                    <div id="not-connected-state" class="visible-smooth">
                        <h2 class="text-2xl font-bold text-white mb-2">Not Connected</h2>
                        <p class="text-gray-400 mb-4">Connect your Spotify account to see what you're listening to</p>
                        <a href="index.html" class="inline-block bg-[#1DB954] hover:bg-[#1ed760] text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105 active:scale-95">
                            Connect Spotify
                        </a>
                    </div>

                    <div id="loading-state" class="hidden-smooth">
                        <div class="space-y-3">
                            <div class="h-7 bg-gray-700 rounded w-3/4 pulse-soft"></div>
                            <div class="h-5 bg-gray-700 rounded w-1/2 pulse-soft"></div>
                            <div class="pt-2">
                                <div class="h-2 bg-gray-700 rounded pulse-soft"></div>
                            </div>
                        </div>
                    </div>

                    <div id="playing-state" class="hidden-smooth">
                        <h2 id="songName" class="text-2xl font-bold text-white truncate mb-1 smooth-transition">Song Name</h2>
                        <p id="artistName" class="text-lg text-gray-300 truncate mb-4 smooth-transition">Artist Name</p>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm text-gray-400">
                                <span id="currentTime" class="smooth-transition">0:00</span>
                                <span id="totalTime" class="smooth-transition">0:00</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="progressBar" class="bg-[#1DB954] h-2 rounded-full smooth-transition" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div id="error-state" class="hidden-smooth">
                        <h2 class="text-2xl font-bold text-white mb-2">Connection Issue</h2>
                        <p id="error-message" class="text-gray-400 mb-4">There was a problem loading your Spotify data</p>
                        <button onclick="fetchNowPlaying()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors mr-3 transform hover:scale-105 active:scale-95">
                            <i class="fas fa-redo mr-2"></i>Retry
                        </button>
                        <a href="index.html" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105 active:scale-95">
                            Reconnect
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Info (Remove in production) -->
        <div id="debug-info" class="mt-4 p-4 bg-gray-800 rounded-lg text-xs text-gray-400 hidden">
            <h3 class="font-bold mb-2">Debug Info:</h3>
            <div id="debug-content"></div>
        </div>

        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>üéµ Each user sees their own Spotify activity</p>
            <p class="mt-1">üîÑ Auto-refreshes every 5 seconds</p>
            <p class="mt-1">üì± Mobile compatible</p>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://spotify-tester.mthaker630.workers.dev'; // ‚Üê Your Worker URL
        
        // Debug logging
        function debugLog(message, data = null) {
            console.log('üîß ' + message, data);
            // Uncomment to show debug info on page
            // document.getElementById('debug-content').innerHTML += `<div>${message} ${data ? JSON.stringify(data) : ''}</div>`;
            // document.getElementById('debug-info').classList.remove('hidden');
        }

        function showState(state, message = '') {
            const states = ['not-connected', 'loading', 'playing', 'error'];
            states.forEach(s => {
                const element = document.getElementById(s + '-state');
                element.classList.remove('visible-smooth');
                element.classList.add('hidden-smooth');
            });
            
            setTimeout(() => {
                const currentElement = document.getElementById(state + '-state');
                currentElement.classList.remove('hidden-smooth');
                currentElement.classList.add('visible-smooth');
            }, 50);
            
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const playerTitle = document.getElementById('player-title');
            
            switch(state) {
                case 'not-connected':
                    statusDot.className = 'w-3 h-3 bg-gray-500 rounded-full smooth-transition';
                    statusText.textContent = 'Not Connected';
                    playerTitle.textContent = 'Your Spotify';
                    document.getElementById('user-profile').classList.add('hidden-smooth');
                    break;
                case 'loading':
                    statusDot.className = 'w-3 h-3 bg-yellow-500 rounded-full smooth-transition pulse-soft';
                    statusText.textContent = 'Loading...';
                    playerTitle.textContent = 'Your Spotify';
                    break;
                case 'playing':
                    statusDot.className = 'w-3 h-3 bg-green-500 rounded-full smooth-transition';
                    statusText.textContent = 'Live';
                    playerTitle.textContent = 'Now Playing';
                    document.getElementById('user-profile').classList.remove('hidden-smooth');
                    break;
                case 'error':
                    statusDot.className = 'w-3 h-3 bg-red-500 rounded-full smooth-transition';
                    statusText.textContent = 'Error';
                    playerTitle.textContent = 'Your Spotify';
                    if (message) document.getElementById('error-message').textContent = message;
                    break;
            }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        async function fetchUserProfile(accessToken) {
            try {
                const response = await fetch(`${WORKER_URL}/api?endpoint=me&token=${accessToken}`);
                const data = await response.json();
                debugLog('User profile response:', data);
                
                if (data.id) {
                    document.getElementById('user-avatar').src = data.images?.[0]?.url || 'https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg';
                    document.getElementById('user-name').textContent = data.display_name || 'Spotify User';
                    document.getElementById('user-email').textContent = data.email || `ID: ${data.id}`;
                    
                    localStorage.setItem('spotify_user_name', data.display_name || 'Spotify User');
                    localStorage.setItem('spotify_user_avatar', data.images?.[0]?.url || '');
                    localStorage.setItem('spotify_user_id', data.id);
                }
            } catch (error) {
                debugLog('Error fetching user profile:', error);
            }
        }

        // NEW: Try multiple endpoints to get playback state
        async function tryMultipleEndpoints(accessToken) {
            const endpoints = [
                'me/player/currently-playing',
                'me/player',  // Fallback to general player state
            ];
            
            for (const endpoint of endpoints) {
                try {
                    debugLog(`Trying endpoint: ${endpoint}`);
                    const response = await fetch(`${WORKER_URL}/api?endpoint=${endpoint}&token=${accessToken}`);
                    
                    if (response.status === 200) {
                        const data = await response.json();
                        debugLog(`Endpoint ${endpoint} success:`, data);
                        return data;
                    } else if (response.status === 204) {
                        debugLog(`Endpoint ${endpoint}: No content (204)`);
                        return { is_playing: false, endpoint: endpoint };
                    } else {
                        debugLog(`Endpoint ${endpoint} failed: ${response.status}`);
                    }
                } catch (error) {
                    debugLog(`Endpoint ${endpoint} error:`, error);
                }
            }
            
            return null;
        }

        async function exchangeCodeForToken(code) {
            showState('loading', 'Connecting to Spotify...');
            
            try {
                const response = await fetch(WORKER_URL + '/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, redirect_uri: window.location.origin + '/live.html' })
                });

                const data = await response.json();
                debugLog('Token exchange response:', data);
                
                if (data.access_token) {
                    localStorage.setItem('spotify_access_token', data.access_token);
                    localStorage.setItem('spotify_refresh_token', data.refresh_token);
                    localStorage.setItem('spotify_token_expiry', Date.now() + (data.expires_in * 1000));
                    localStorage.setItem('spotify_connected', 'true');
                    
                    await fetchUserProfile(data.access_token);
                    return data;
                } else {
                    throw new Error(data.error_description || 'Failed to get token');
                }
            } catch (error) {
                debugLog('Token exchange error:', error);
                throw error;
            }
        }

        function isTokenExpired() {
            const tokenExpiry = localStorage.getItem('spotify_token_expiry');
            return tokenExpiry && Date.now() > parseInt(tokenExpiry);
        }

        async function fetchNowPlaying() {
            const accessToken = localStorage.getItem('spotify_access_token');
            
            if (!accessToken || isTokenExpired()) {
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_connected');
                showState('not-connected');
                return;
            }

            showState('loading', 'Loading your music...');

            try {
                // Try multiple endpoints to get playback state
                const data = await tryMultipleEndpoints(accessToken);
                debugLog('Final playback data:', data);

                if (!data) {
                    throw new Error('Could not fetch playback state from any endpoint');
                }

                if (data.error) {
                    throw new Error(data.error.message || 'Spotify API error');
                }

                // Handle different response formats
                const isPlaying = data.is_playing;
                const track = data.item || (data.context && data.context.type === 'track' ? data : null);

                if (!isPlaying || !track) {
                    document.getElementById('songName').textContent = "No music playing";
                    document.getElementById('artistName').textContent = "Play something on Spotify to see it here!";
                    document.getElementById('albumArt').src = "https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg";
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('currentTime').textContent = "0:00";
                    document.getElementById('totalTime').textContent = "0:00";
                    showState('playing');
                    return;
                }

                // Update UI with track data
                setTimeout(() => {
                    document.getElementById('songName').textContent = track.name || 'Unknown Track';
                    document.getElementById('artistName').textContent = track.artists ? track.artists.map(a => a.name).join(", ") : 'Unknown Artist';
                    document.getElementById('albumArt').src = track.album?.images?.[0]?.url || "https://upload.wikimedia.org/wikipedia/commons/8/84/Spotify_icon.svg";
                    
                    const progressMs = data.progress_ms || 0;
                    const durationMs = track.duration_ms || 0;
                    const progressPercent = durationMs > 0 ? (progressMs / durationMs) * 100 : 0;
                    
                    document.getElementById('progressBar').style.width = `${progressPercent}%`;
                    document.getElementById('currentTime').textContent = formatTime(progressMs);
                    document.getElementById('totalTime').textContent = formatTime(durationMs);
                }, 100);
                
                showState('playing');
                
            } catch (error) {
                debugLog('Fetch error:', error);
                showState('error', error.message);
            }
        }

        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                debugLog('OAuth Error:', error);
                showState('error', `Spotify authorization failed: ${error}`);
                return;
            }

            if (code) {
                try {
                    debugLog('Processing OAuth callback with code');
                    const tokenData = await exchangeCodeForToken(code);
                    
                    if (tokenData.access_token) {
                        debugLog('OAuth successful');
                        const cleanUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, '', cleanUrl);
                        showState('loading', 'Loading your music...');
                        setTimeout(fetchNowPlaying, 1000);
                    }
                } catch (error) {
                    debugLog('OAuth processing error:', error);
                    showState('error', `Connection failed: ${error.message}`);
                }
            }
        }

        function loadStoredUserProfile() {
            const userName = localStorage.getItem('spotify_user_name');
            const userAvatar = localStorage.getItem('spotify_user_avatar');
            if (userName) document.getElementById('user-name').textContent = userName;
            if (userAvatar) document.getElementById('user-avatar').src = userAvatar;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredUserProfile();
            
            const isConnected = localStorage.getItem('spotify_connected') === 'true';
            const urlParams = new URLSearchParams(window.location.search);
            const hasCode = urlParams.get('code');
            
            if (hasCode) {
                handleOAuthCallback();
            } else if (isConnected) {
                showState('loading');
                setTimeout(fetchNowPlaying, 100);
                setInterval(fetchNowPlaying, 5000);
            } else {
                showState('not-connected');
            }
        });
    </script>
</body>
</html>
